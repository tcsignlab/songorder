<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: black; color: white; }
        h1, h2 { text-align: center; color: white; }
        label { font-weight: bold; color: white; }
        input, textarea { width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; background: #333; color: white; border: 1px solid #555; }
        textarea { height: 100px; }
        #controls { margin: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 8px 12px; cursor: pointer; background: #444; color: white; border: 1px solid #666; border-radius: 4px; }
        button:hover { background: #555; }
        #palette, #blocks { display: flex; overflow-x: auto; padding: 10px 0; gap: 10px; align-items: center; }
        .block {
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            cursor: move;
            padding: 10px;
            box-sizing: border-box;
        }
        .block .delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
        }
        .block .name, .block .mult { margin: 0 5px; }
        .block::after {
            content: 'â†’';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #ccc;
        }
        .block:last-child::after { content: ''; }
        @media print {
            body { margin: 0; background: white; color: black; }
            #controls, #palette, .delete, h2:first-of-type { display: none !important; }
            #blocks { gap: 0; }
            .block { page-break-inside: avoid; margin: 5px; color: black !important; }
            .block::after { color: #333; }
        }
        .ghost { opacity: 0.4; }
    </style>
</head>
<body>
    <h1>Song Builder</h1>
    
    <label>Working Song Title:</label>
    <input type="text" id="title" placeholder="Enter working title">
    
    <label>Notes:</label>
    <textarea id="notes" placeholder="Enter notes here..."></textarea>
    
    <div id="controls">
        <button onclick="addBlock()">Add Custom Block</button>
        <button onclick="saveSong()">Save File</button>
        <label for="loadFile">Load File: <input type="file" id="loadFile" accept=".json" style="display:inline; background: transparent; border: none; color: white;"></label>
        <button onclick="printSong()">Print</button>
        <button onclick="saveScreenshot()">Save Screenshot</button>
        <button onclick="newSong()">Clear</button>
    </div>
    
    <h1>Available Blocks</h1>
    <div id="palette"></div>
    
    <h1>Drag Blocks Here</h1><p><center>(Hold + Drag to Re-Order / Double Click to Adjust Multiplier 1x - 16x)</center></p>
    <div id="blocks"></div>

    <script>
        const colorMap = {
            'Intro': '#007bff',
            'Chorus': '#28a745',
            'Verse': '#ffc107',
            'Pre-Chorus': '#6f42c1',
            'Bridge': '#fd7e14',
            'Interlude': '#17a2b8',
            'Outro': '#dc3545'
        };
        const colors = ['#007bff', '#28a745', '#ffc107', '#6f42c1', '#17a2b8', '#dc3545', '#fd7e14'];

        const paletteEl = document.getElementById('palette');
        const blocksEl = document.getElementById('blocks');

        new Sortable(paletteEl, {
            group: { name: 'song', pull: 'clone', put: false },
            sort: false,
            animation: 150,
            ghostClass: 'ghost'
        });

        new Sortable(blocksEl, {
            group: 'song',
            animation: 150,
            ghostClass: 'ghost',
            onAdd: function(evt) {
                const item = evt.item;
                if (!item.querySelector('.delete')) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete';
                    deleteBtn.title = 'Delete';
                    deleteBtn.innerText = 'X';
                    item.insertBefore(deleteBtn, item.firstChild);
                }
                const nameSpan = item.querySelector('.name');
                if (nameSpan) nameSpan.contentEditable = 'true';
            }
        });

        function createBlock(name, mult, color, isPalette = false) {
            const block = document.createElement('div');
            block.className = 'block';
            block.style.backgroundColor = color;
            block.style.width = (80 + mult * 30) + 'px';
            block.innerHTML = `
                ${!isPalette ? '<button class="delete" title="Delete">X</button>' : ''}
                <span class="name" ${!isPalette ? 'contenteditable="true"' : ''}>${name}</span>
                <span class="mult">${mult}x</span>
            `;
            return block;
        }

        function populatePalette() {
            paletteEl.innerHTML = '';
            paletteEl.appendChild(createBlock('Intro', 8, colorMap['Intro'], true));
            paletteEl.appendChild(createBlock('Verse', 8, colorMap['Verse'], true));
            paletteEl.appendChild(createBlock('Pre-Chorus', 4, colorMap['Pre-Chorus'], true));
            paletteEl.appendChild(createBlock('Chorus', 4, colorMap['Chorus'], true));
            paletteEl.appendChild(createBlock('Bridge', 4, colorMap['Bridge'], true));
            paletteEl.appendChild(createBlock('Interlude', 4, colorMap['Interlude'], true));
            paletteEl.appendChild(createBlock('Outro', 8, colorMap['Outro'], true));
        }

        populatePalette();

        document.addEventListener('click', e => {
            if (e.target.classList.contains('delete')) {
                e.target.parentNode.remove();
            }
        });

        document.addEventListener('blur', e => {
            if (e.target.classList.contains('name')) {
                let name = e.target.innerText.trim() || 'Section';
                e.target.innerText = name;
                const nameLower = name.toLowerCase();
                let newColor;
                for (let key in colorMap) {
                    if (key.toLowerCase() === nameLower) {
                        newColor = colorMap[key];
                        break;
                    }
                }
                if (newColor) {
                    e.target.parentNode.style.backgroundColor = newColor;
                }
            }
        }, true);

        document.addEventListener('dblclick', e => {
            const block = e.target.closest('.block');
            if (block && block.parentNode.id === 'blocks') {
                const multSpan = block.querySelector('.mult');
                const currentMult = parseInt(multSpan.innerText.replace('x', ''), 10);
                const newMultStr = prompt('Enter new multiplier (1-16):', currentMult);
                if (newMultStr !== null) {
                    let newMult = parseInt(newMultStr, 10);
                    newMult = Math.max(1, Math.min(16, isNaN(newMult) ? currentMult : newMult));
                    multSpan.innerText = newMult + 'x';
                    block.style.width = (80 + newMult * 30) + 'px';
                }
            }
        });

        function addBlock() {
            const name = prompt('Block name:', 'Custom') || 'Section';
            let mult = parseInt(prompt('Block width (1-16):', '4'), 10) || 4;
            mult = Math.max(1, Math.min(16, mult));
            const nameLower = name.toLowerCase();
            let color = colors[Math.floor(Math.random() * colors.length)];
            for (let key in colorMap) {
                if (key.toLowerCase() === nameLower) {
                    color = colorMap[key];
                    break;
                }
            }
            const block = createBlock(name, mult, color);
            blocksEl.appendChild(block);
        }

        function getSongData() {
            const blocks = [];
            document.querySelectorAll('#blocks .block').forEach(b => {
                const name = b.querySelector('.name').innerText.trim();
                const multText = b.querySelector('.mult').innerText.trim();
                const mult = parseInt(multText.replace('x', ''), 10) || 1;
                blocks.push({ name, mult, color: b.style.backgroundColor });
            });
            return {
                title: document.getElementById('title').value.trim(),
                notes: document.getElementById('notes').value.trim(),
                blocks
            };
        }

        function saveSong() {
            const song = getSongData();
            const title = song.title || 'song';
            const blob = new Blob([JSON.stringify(song, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = title.replace(/[^a-z0-9]/gi, '_') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('loadFile').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const song = JSON.parse(ev.target.result);
                    document.getElementById('title').value = song.title || '';
                    document.getElementById('notes').value = song.notes || '';
                    blocksEl.innerHTML = '';
                    if (song.blocks && Array.isArray(song.blocks)) {
                        song.blocks.forEach(b => {
                            const block = createBlock(b.name || 'Section', b.mult || 4, b.color);
                            blocksEl.appendChild(block);
                        });
                    }
                } catch (err) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        });

        function printSong() {
            window.print();
        }

        function saveScreenshot() {
            html2canvas(document.body).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'song_structure.png';
                a.click();
            });
        }

        function newSong() {
            if (confirm('Clear everything?')) {
                document.getElementById('title').value = '';
                document.getElementById('notes').value = '';
                blocksEl.innerHTML = '';
                populatePalette(); // Reset palette if needed, but since clone, not necessary
            }
        }
    </script>
</body>
</html>
