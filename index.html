<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Builder For RatBats</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: black; color: white; }
        h1, h2 { text-align: center; color: white; }
        label { font-weight: bold; color: white; }
        input, textarea { width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; background: #333; color: white; border: 1px solid #555; }
        textarea { height: 100px; }
        #controls { margin: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 8px 12px; cursor: pointer; background: #444; color: white; border: 1px solid #666; border-radius: 4px; }
        button:hover { background: #555; }
        #palette, #blocks { display: flex; overflow-x: auto; padding: 10px 0; gap: 10px; align-items: center; }
        .block {
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            cursor: move;
            padding: 10px;
            box-sizing: border-box;
        }
        .block .delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
        }
        .block .name, .block .mult { margin: 0 5px; }
        .block::after {
            content: '→';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #ccc;
        }
        .block:last-child::after { content: ''; }
        @media print {
            body { margin: 0; background: white; color: black; }
            #controls, #palette, .delete, h2:first-of-type { display: none !important; }
            #blocks { gap: 0; }
            .block { page-break-inside: avoid; margin: 5px; color: black !important; }
            .block::after { color: #333; }
        }
        .ghost { opacity: 0.4; }
        .hero {
            height: 65%;
            background: url('https://i.ibb.co/FLVWkz41/songbuilder.jpg') no-repeat center center;
            background-size: contain;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .hero h1 {
            margin: 0;
            font-size: 3em;
        }
        #orientation-message {
            display: none;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 24px;
            text-align: center;
            color: white;
        }
        @media (orientation: portrait) {
            #content {
                display: none;
            }
            #orientation-message {
                display: flex;
            }
        }
        @media (orientation: landscape) {
            #orientation-message {
                display: none;
            }
        }
        @media (max-width: 1024px) {
            body { margin: 10px; }
            .hero { height: 200px; }
            .hero h1 { font-size: 2em; }
            .block {
                min-height: 60px;
                font-size: 12px;
                padding: 5px;
            }
            .block .delete {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
            .block::after {
                right: -15px;
                font-size: 18px;
            }
            #palette, #blocks {
                gap: 5px;
                padding: 5px 0;
            }
            h1 { font-size: 1.5em; }
            p { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div id="orientation-message">Please rotate your device to landscape mode to use the Song Builder.</div>
    <div id="content">
        <div class="hero">
        </div>
      
        <label>Working Song Title:</label>
        <input type="text" id="title" placeholder="Enter working title">
      
        <label>Notes:</label>
        <textarea id="notes" placeholder="Enter notes here..."></textarea>
      
        <div id="controls">
            <label for="loadFile">Load File: <input type="file" id="loadFile" accept=".json" style="display:inline; background: transparent; border: none; color: white;"></label>
            <button onclick="saveSong()">Save File</button>
            <button onclick="printSong()">Print</button>
            <button onclick="saveScreenshot()">Save Screenshot</button>
            <button onclick="newSong()">Clear</button>
        </div>
      
        <h1>Instructions:</h1><p><center>
1. Enter your song title and notes in the top fields.<p>2. Drag blocks like Intro or Verse from the palette below to the bottom area to build your structure.</p>
            <p>3. Hold and drag to reorder blocks, or click the X to delete one.</p><p>4. Double-click a block to change its multiplier (1-16x) for length.</p>
            <p>5. Edit a block's name by clicking it; matching names update colors automatically.</p><p>6. Use buttons to save/load as FILE, print, screenshot, or clear everything.</p>
            <p>7. Blocks show arrows between them for flow.</p><p>8. Save often to keep your work!</p>
    </p></center>
        <div id="palette"></div>
      
        <h1>⬇️ DRAG BLOCKS BELOW ⬇️</h1>
        <div id="blocks"></div>
    </div>
    <script>
        const colorMap = {
            'Intro': '#007bff',
            'Chorus': '#28a745',
            'Verse': '#ffc107',
            'Pre-Chorus': '#6f42c1',
            'Bridge': '#fd7e14',
            'Interlude': '#17a2b8',
            'Outro': '#dc3545',
            'Custom': '#ff0000'
        };
        const colors = ['#007bff', '#28a745', '#ffc107', '#6f42c1', '#17a2b8', '#dc3545', '#fd7e14'];
        const paletteEl = document.getElementById('palette');
        const blocksEl = document.getElementById('blocks');
        new Sortable(paletteEl, {
            group: { name: 'song', pull: 'clone', put: false },
            sort: false,
            animation: 150,
            ghostClass: 'ghost'
        });
        new Sortable(blocksEl, {
            group: 'song',
            animation: 150,
            ghostClass: 'ghost',
            onAdd: function(evt) {
                const item = evt.item;
                if (!item.querySelector('.delete')) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete';
                    deleteBtn.title = 'Delete';
                    deleteBtn.innerText = 'X';
                    item.insertBefore(deleteBtn, item.firstChild);
                }
                const nameSpan = item.querySelector('.name');
                if (nameSpan) nameSpan.contentEditable = 'true';
                updateBlockWidth(item);
            }
        });
        function createBlock(name, mult, color, isPalette = false) {
            const block = document.createElement('div');
            block.className = 'block';
            block.style.backgroundColor = color;
            block.setAttribute('data-mult', mult);
            block.innerHTML = `
                ${!isPalette ? '<button class="delete" title="Delete">X</button>' : ''}
                <span class="name" ${!isPalette ? 'contenteditable="true"' : ''}>${name}</span>
                <span class="mult">${mult}x</span>
            `;
            updateBlockWidth(block);
            return block;
        }
        function updateBlockWidth(block) {
            const mult = parseInt(block.getAttribute('data-mult') || block.querySelector('.mult').innerText.replace('x', ''), 10);
            const baseWidth = window.innerWidth <= 1024 ? 60 : 80;
            const multFactor = window.innerWidth <= 1024 ? 20 : 30;
            block.style.width = (baseWidth + mult * multFactor) + 'px';
        }
        function populatePalette() {
            paletteEl.innerHTML = '';
            paletteEl.appendChild(createBlock('Intro', 8, colorMap['Intro'], true));
            paletteEl.appendChild(createBlock('Verse', 8, colorMap['Verse'], true));
            paletteEl.appendChild(createBlock('Pre-Chorus', 4, colorMap['Pre-Chorus'], true));
            paletteEl.appendChild(createBlock('Chorus', 4, colorMap['Chorus'], true));
            paletteEl.appendChild(createBlock('Bridge', 4, colorMap['Bridge'], true));
            paletteEl.appendChild(createBlock('Interlude', 4, colorMap['Interlude'], true));
            paletteEl.appendChild(createBlock('Outro', 8, colorMap['Outro'], true));
            paletteEl.appendChild(createBlock('Custom', 4, colorMap['Custom'], true));
        }
        populatePalette();
        document.addEventListener('click', e => {
            if (e.target.classList.contains('delete')) {
                e.target.parentNode.remove();
            }
        });
        document.addEventListener('blur', e => {
            if (e.target.classList.contains('name')) {
                let name = e.target.innerText.trim() || 'Section';
                e.target.innerText = name;
                const nameLower = name.toLowerCase();
                let newColor;
                for (let key in colorMap) {
                    if (key.toLowerCase() === nameLower) {
                        newColor = colorMap[key];
                        break;
                    }
                }
                if (newColor) {
                    e.target.parentNode.style.backgroundColor = newColor;
                }
            }
        }, true);
        document.addEventListener('dblclick', e => {
            const block = e.target.closest('.block');
            if (block && block.parentNode.id === 'blocks') {
                const multSpan = block.querySelector('.mult');
                const currentMult = parseInt(multSpan.innerText.replace('x', ''), 10);
                const newMultStr = prompt('Enter new multiplier (1-16):', currentMult);
                if (newMultStr !== null) {
                    let newMult = parseInt(newMultStr, 10);
                    newMult = Math.max(1, Math.min(16, isNaN(newMult) ? currentMult : newMult));
                    multSpan.innerText = newMult + 'x';
                    block.setAttribute('data-mult', newMult);
                    updateBlockWidth(block);
                }
            }
        });
        function getSongData() {
            const blocks = [];
            document.querySelectorAll('#blocks .block').forEach(b => {
                const name = b.querySelector('.name').innerText.trim();
                const multText = b.querySelector('.mult').innerText.trim();
                const mult = parseInt(multText.replace('x', ''), 10) || 1;
                blocks.push({ name, mult, color: b.style.backgroundColor });
            });
            return {
                title: document.getElementById('title').value.trim(),
                notes: document.getElementById('notes').value.trim(),
                blocks
            };
        }
        function saveSong() {
            const song = getSongData();
            const title = song.title || 'song';
            const blob = new Blob([JSON.stringify(song, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = title.replace(/[^a-z0-9]/gi, '_') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        document.getElementById('loadFile').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const song = JSON.parse(ev.target.result);
                    document.getElementById('title').value = song.title || '';
                    document.getElementById('notes').value = song.notes || '';
                    blocksEl.innerHTML = '';
                    if (song.blocks && Array.isArray(song.blocks)) {
                        song.blocks.forEach(b => {
                            const block = createBlock(b.name || 'Section', b.mult || 4, b.color);
                            blocksEl.appendChild(block);
                        });
                    }
                } catch (err) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        });
        function printSong() {
            window.print();
        }
        function saveScreenshot() {
            html2canvas(document.body).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'song_structure.png';
                a.click();
            });
        }
        function newSong() {
            if (confirm('Clear everything?')) {
                document.getElementById('title').value = '';
                document.getElementById('notes').value = '';
                blocksEl.innerHTML = '';
                populatePalette(); // Reset palette if needed, but since clone, not necessary
            }
        }
        // Update block widths on resize (for orientation changes)
        window.addEventListener('resize', () => {
            document.querySelectorAll('.block').forEach(updateBlockWidth);
        });
    </script>
</body>
</html>
